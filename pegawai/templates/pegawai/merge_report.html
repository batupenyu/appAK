{% extends 'pegawai/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 no-print">Angka Kredit</h1>

    <div class="card shadow mb-4 no-print">
        <div class="card-body">
            <form method="post" action="{% url 'merge_report' %}">
                {% csrf_token %}
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="pegawai_id">Pilih Pegawai:</label>
                        <select name="pegawai_id" id="pegawai_id" class="form-control" onchange="this.form.submit()">
                            <option value="">--- Pilih Pegawai ---</option>
                            {% for pegawai in pegawai_options %}
                                <option value="{{ pegawai.id }}" {% if pegawai.id|stringformat:"s" == selected_pegawai_id|stringformat:"s" %}selected{% endif %}>
                                    {{ pegawai.nama }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if selected_pegawai_id %}
                    <div class="col-md-4">
                        <label class="form-label">Filter by Periode:</label>
                        <div class="d-flex">
                            <input type="date" name="start_date" class="form-control me-2" value="{{ start_date|date:'Y-m-d' }}">
                            <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                            <button type="submit" name="filter_report" class="btn btn-secondary ms-2">Filter</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Pilih Data untuk Laporan:</label>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                Pilih Periode & Opsi
                            </button>
                            <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton" style="max-height: 300px; overflow-y: auto;">
                                {% if not all_ak_records and not angka_integrasi_obj %}
                                <a class="dropdown-item text-muted">Tidak ada data AK pada rentang periode ini.</a>
                                {% endif %}
                                {% if angka_integrasi_obj %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="selected_periods" value="integrasi_ak" id="integrasi_ak" {% if 'integrasi_ak' in selected_periods %}checked{% endif %}>
                                    <label class="form-check-label" for="integrasi_ak">
                                        Sertakan Angka Integrasi ({{ angka_integrasi_obj.jumlah_angka_integrasi }})
                                    </label>
                                </div>
                                {% endif %}

                                {% if ak_pendidikan_records %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="selected_periods" value="pendidikan_ak" id="pendidikan_ak" {% if 'pendidikan_ak' in selected_periods %}checked{% endif %}>
                                    <label class="form-check-label" for="pendidikan_ak">
                                        Sertakan Angka Kredit Pendidikan ({{ ak_pendidikan_records|length }} item)
                                    </label>
                                </div>
                                <hr class="my-2">
                                {% endif %}

                                {% for ak in all_ak_records %}
                                <div class="form-check">
                                    <input class="form-check-input period-check" type="checkbox" name="selected_periods" value="{{ ak.id }}" id="period_{{ ak.id }}" {% if ak.id|stringformat:"s" in selected_periods %}checked{% endif %}>
                                    <label class="form-check-label" for="period_{{ ak.id }}">
                                        {{ ak.tanggal_awal_penilaian|date:"d M Y" }} - {{ ak.tanggal_akhir_penilaian|date:"d M Y" }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 align-self-end">
                        <button type="submit" name="generate_report" class="btn btn-primary">Generate Report</button>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    {% if report_generated %}
        <div class="card shadow mb-4">
            <div class="card-body" id="print-area">
                <!-- Konversi Report -->
                {% with report_data=report_data.konversi.report_data ak_list=report_data.konversi.ak_list %}
                    <div id="konversi-section">
                        {% include 'pegawai/konversi_report_template.html' %}
                    </div>
                {% endwith %}
                
                <!-- Akumulasi Report -->
                {% with report_data=report_data.akumulasi ak_list=report_data.akumulasi.ak_list %}
                    <div id="akumulasi-section">
                        {% include 'pegawai/akumulasi_report_template.html' %}
                    </div>
                {% endwith %}

                <!-- Penetapan Report -->
                {% with report_data=report_data.penetapan ak_list=report_data.penetapan.ak_list %}
                    <div id="penetapan-section">
                        {% include 'pegawai/penetapan_report_template.html' %}
                    </div>
                {% endwith %}
            </div>
             <div class="card-footer no-print">
                <button onclick="printReport()" class="btn btn-primary me-2">Cetak</button>
                <a href="#" id="pdf-link" class="btn btn-success">Cetak PDF Bersih</a>
            </div>
        </div>

        <style>
            @page {
                margin: 1cm;
            }
            @media print {
                .no-print {
                    display: none;
                }
                body {
                    margin: 0;
                    padding: 0;
                }
                .content {
                    margin: 0;
                    padding: 0;
                    width: auto;
                }
                #report-content {
                    padding: 0 !important;
                }
                #print-area .card,
                #print-area .card-body {
                    margin: 0 !important;
                    padding: 0 !important;
                    border: none !important;
                    box-shadow: none !important;
                }
                .personal-table tr, .credit-table tr {
                    page-break-inside: avoid;
                }
                #akumulasi-section, #penetapan-section {
                    page-break-before: always;
                }
            }
        </style>
        <script>
            function printReport() {
                window.print();
            }

            // Update the PDF link to include the AkPendidikan checkbox state
            document.addEventListener('DOMContentLoaded', function() {
                const pdfLink = document.getElementById('pdf-link');
                if (pdfLink) {
                    // Build the base URL with existing parameters
                    let baseUrl = '{% url 'merge_report_pdf' %}?pegawai_id={{ selected_pegawai_id }}';

                    // Add selected periods
                    {% for period in selected_periods %}
                        baseUrl += '&selected_periods={{ period }}';
                    {% endfor %}

                    // Add date range if available
                    {% if start_date %}
                        baseUrl += '&start_date={{ start_date|date:'Y-m-d' }}';
                    {% endif %}
                    {% if end_date %}
                        baseUrl += '&end_date={{ end_date|date:'Y-m-d' }}';
                    {% endif %}

                    // Check if AkPendidikan checkbox is checked and add to URL
                    const pendidikanCheck = document.getElementById('pendidikan_ak');
                    if (pendidikanCheck && pendidikanCheck.checked) {
                        baseUrl += '&include_ak_pendidikan=true';
                    }

                    pdfLink.href = baseUrl;
                }
            });
        </script>
    {% endif %}
</div>
{% endblock %}

{% block extra_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropdownMenu = document.querySelector('.dropdown-menu');
    if (dropdownMenu) {
        dropdownMenu.addEventListener('click', function (e) {
            e.stopPropagation();
        });
    }
});
</script>
{% endblock %}