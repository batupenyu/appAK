{% extends 'pegawai/base.html' %}

{% block title %}Penetapan{% endblock %}

{% block content %}
    <div class="card mb-3">
        <div class="card-header">
            <h3>Penetapan Report</h3>
        </div>
        <div class="card-body">
            <form method="POST" class="mb-3">
                {% csrf_token %}
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label for="pegawai_select" class="form-label">Pilih Pegawai:</label>
                        <select name="pegawai_id" id="pegawai_select" class="form-select" required>
                            <option value="">-- Pilih Pegawai --</option>
                            {% for p in pegawai_options %}
                            <option value="{{ p.id }}" {% if selected_pegawai_id == p.id %}selected{% endif %}>{{ p.nama }} - {{ p.nip }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Pilih Data untuk Laporan:</label>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                Pilih Periode & Opsi
                            </button>
                            <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton" style="max-height: 300px; overflow-y: auto;">
                                {% for ak_item in all_ak_records %}
                                <div class="form-check">
                                    <input class="form-check-input period-check" type="checkbox" name="selected_periods" value="{{ ak_item.id }}" id="period_{{ ak_item.id }}"
                                        {% if ak_item.id|stringformat:"s" in selected_periods %}checked{% endif %}>
                                    <label class="form-check-label" for="period_{{ ak_item.id }}">
                                        {% if ak_item.is_integrasi_option %}
                                            {{ ak_item.penilaian }}
                                        {% elif ak_item.is_pendidikan_option %}
                                            {{ ak_item.penilaian }}
                                        {% else %}
                                            {{ ak_item.tanggal_awal_penilaian|date:"d M Y" }} - {{ ak_item.tanggal_akhir_penilaian|date:"d M Y" }} ({{ ak_item.penilaian }})
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}

                                <hr class="my-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="include_ak_pendidikan" value="true" id="pendidikan_check"
                                        {% if include_ak_pendidikan %}checked{% endif %}>
                                    <label class="form-check-label" for="pendidikan_check">
                                        Sertakan Angka Kredit Pendidikan
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 align-self-end">
                        <button type="submit" class="btn btn-primary">Generate Report</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if report_generated %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Laporan Penetapan untuk {{ report_data.pegawai.nama }}</h4>
            <div>
                <a href="{% url 'penetapan_pdf' %}?pegawai_id={{ report_data.pegawai.id }}{% if selected_periods %}{% for p_id in selected_periods %}&selected_periods={{ p_id }}{% endfor %}{% endif %}" class="btn btn-success me-2" target="_blank"><i class="fas fa-file-pdf"></i> Cetak PDF</a>
            </div>
        </div>
        <div class="card-body">
            <div id="report-content" class="p-3">
                <div class="text-center font-bold mb-4">
                    <p class="h5">PENETAPAN ANGKA KREDIT</p>
                    <p class="h6">NOMOR : 800/ ......... /.........../Dindik/{% if report_data.tahun %}{{ report_data.tahun }}{% else %}TAHUN{% endif %}/PAK</p>

                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    <span>Instansi : {{ report_data.nama_instansi }}</span>
                    <span>Periode : {{ report_data.periode_awal_str }} s.d. {{ report_data.periode_akhir_str }}</span>
                    
                </div>

                <table class="table table-bordered table-sm mb-4">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 5%;">I.</th>
                            <th  colspan="3" style="width: 95%;text-align: left;">KETERANGAN PERORANGAN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center">1.</td>
                            <td style="width: 30%; border-right: none">Nama</td>
                            <td class="text-center" style="width: 2%;">:</td>
                            <td style="width: 63%;">{{ report_data.pegawai.nama }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">2.</td>
                            <td style="border-right: none">NIP</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.nip }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">3.</td>
                            <td style="border-right: none">No. Seri Karpeg</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.no_seri_karpeg }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">4.</td>
                            <td style="border-right: none">Tempat Tgl. Lahir</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.tempat_lahir }}, {{ report_data.pegawai.tanggal_lahir|date:"d-m-Y" }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">5.</td>
                            <td style="border-right: none">Jenis Kelamin</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.jenis_kelamin }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">6.</td>
                            <td style="border-right: none">Pangkat/Golongan ruang/TMT</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.pangkat }}, {{ report_data.pegawai.golongan }}, {{ report_data.pegawai.tmt_pangkat|date:"d-m-Y" }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">7.</td>
                            <td style="border-right: none">Jabatan /TMT</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.jabatan_dan_tmt }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">8.</td>
                            <td style="border-right: none">Unit Kerja</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.pegawai.unit_kerja }}</td>
                        </tr>
                        <tr>
                            <td class="text-center">9.</td>
                            <td style="border-right: none">Instansi</td>
                            <td class="text-center">:</td>
                            <td>{{ report_data.nama_instansi }}</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- <table class="table table-bordered table-sm mb-4"> -->
                <table class="table table-bordered table-sm mb-4">
                    <thead>
                        <tr>
                            <th class="text-center" colspan="6">HASIL PENILAIAN ANGKA KREDIT</th>
                        </tr>
                        <tr>
                            <th class="text-center" style="width: 5%;">II.</th>
                            <th class="text-center" style="width: 45%;">PENETAPAN ANGKA KREDIT</th>
                            <th class="text-center" style="width: 10%;">LAMA</th>
                            <th class="text-center" style="width: 10%;">BARU</th>
                            <th class="text-center" style="width: 10%;">JUMLAH</th>
                            <th class="text-center" style="width: 20%;">KETERANGAN</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center">1.</td>
                            <td>AK dasar yang diberikan</td>
                            <td style="text-align: right;"></td>
                            <td style="text-align: right;"></td>
                            <td style="text-align: right;"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="text-center">2.</td>
                            <td>AK konversi dari predikat</td>
                            <!-- Kolom: Lama | Baru (tambahan) | Total -->
                            <td style="text-align: right;">{{ report_data.total_lama|floatformat:"3" }}</td>
                            <td style="text-align: right;">{{ report_data.total_baru|floatformat:"3" }}</td>
                            <td style="text-align: right;">{{ report_data.total_performance_only|floatformat:"3" }}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="text-center">3.</td>
                            <td>AK penyesuaian penyetaraan</td>
                            <td style="text-align: right;"></td>
                            <td style="text-align: right;"></td>
                            <td style="text-align: right;"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="text-center">4.</td>
                            <td>AK yang diperoleh dari peningkatan pendidikan</td>
                            <td style="text-align: right;">-</td>
                            <td style="text-align: right;">{% if report_data.ak_pendidikan_value %}{{ report_data.ak_pendidikan_value|floatformat:"3" }}{% else %}-{% endif %}</td>
                            <td style="text-align: right;">{% if report_data.ak_pendidikan_value %}{{ report_data.ak_pendidikan_value|floatformat:"3" }}{% else %}-{% endif %}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td class="text-center font-bold">5.</td>
                            <td class="font-bold">JUMLAH</td>
                            <td class="font-bold" style="text-align: right;">{{ report_data.total_lama|floatformat:"3" }}</td>
                            <td class="font-bold" style="text-align: right;">{{ report_data.total_baru_with_pendidikan|floatformat:"3" }}</td>
                            <td class="font-bold" style="text-align: right;">{{ report_data.total_jumlah|floatformat:"3" }}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                <table class="table table-bordered table-sm mb-4">
                    <thead>
                        <tr>
                            <th class="text-center" colspan="3">KONVERSI KE ANGKA KREDIT</th>
                        </tr>
                        <tr>
                            <th class="text-center" style="width: 50%;">Keterangan</th>
                            <th class="text-center" style="width: 25%;">Pangkat</th>
                            <th class="text-center" style="width: 25%;">Jenjang Jabatan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: justify;">Angka Kredit minimal yang harus dipenuhi untuk kenaikan pangkat / jenjang</td>
                            <td style="text-align: right; padding-right: 100px;">{{ report_data.pangkat_minimal|floatformat:"3" }}</td>
                            <td style="text-align: right; padding-right: 100px;">{{ report_data.jenjang_minimal|floatformat:"3" }}</td>
                        </tr>
                        <tr>
                            <td>
                                {% if report_data.hasil_pangkat > 0 %}
                                    Kelebihan/<span style="text-decoration: line-through;">Kekurangan</span>
                                {% else %}
                                    <span style="text-decoration: line-through;">Kelebihan</span>/Kekurangan
                                {% endif %}
                                *) Angka Kredit yang harus dicapai untuk kenaikan pangkat.
                            </td>
                            <td style="text-align: right; padding-right: 100px;">{{ report_data.hasil_pangkat|floatformat:"3" }}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                {% if report_data.hasil_jenjang > 0 %}
                                    Kelebihan/<span style="text-decoration: line-through;">Kekurangan</span>
                                {% else %}
                                    <span style="text-decoration: line-through;">Kelebihan</span>/Kekurangan
                                {% endif %}
                                *) Angka Kredit yang harus dicapai untuk kenaikan jenjang.
                            </td>
                            <td></td>
                            <td style="text-align: right; padding-right: 100px;">{{ report_data.hasil_jenjang|floatformat:"3" }}</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-justify">
                                <b><i>{% if report_data.hasil_pangkat > 0 %}Dapat{% else %}Tidak dapat{% endif %}</i></b>
                                dipertimbangkan untuk kenaikan Pangkat/Jabatan setingkat lebih tinggi ke
                                <b><i>{{ report_data.teks_tujuan }}</i></b>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="row mt-5">
                    <div class="col-8">
                        <p>ASLI disampaikan dengan hormat kepada: <br>
                        Jabatan Fungsional yang bersangkutan. </p><br>
                        <p>Tembusan disampaikan kepada: <br>
                        1. Pimpinan Unit Kerja; <br>
                        2. Pejabat Penilai Kinerja;<br>
                        3. Sekretaris Tim Penilai yang bersangkutan; dan <br>
                        4. Kepala Biro Kepegawaian dan Organisasi.</p>
                    </div>
                    <div class="col-4 text-center">
                        Ditetapkan di {{ report_data.tempat_ditetapkan }} <br>
                        Pada tanggal, {{ report_data.tanggal_ditetapkan|date:"d-m-Y" }}. <br><br>
                        Pejabat Penilai Kinerja <br><br><br><br><br>
                        <span class="font-bold">{{ report_data.nama_penilai }}</span> <br>
                        {{ report_data.pangkat_penilai }}, {{ report_data.golongan_penilai }}<br>
                        NIP. {{ report_data.nip_penilai }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent dropdown from closing when clicking on a checkbox
        const dropdownMenu = document.querySelector('.dropdown-menu');
        if (dropdownMenu) {
            dropdownMenu.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Update the PDF link to include the AkPendidikan checkbox state
        const pdfLink = document.querySelector('a[href*="penetapan_pdf"]');
        if (pdfLink) {
            const includePendidikan = document.getElementById('pendidikan_check')?.checked || false;
            if (includePendidikan) {
                const currentUrl = new URL(pdfLink.href);
                currentUrl.searchParams.set('include_ak_pendidikan', 'true');
                pdfLink.href = currentUrl.toString();
            }
        }
    });
    </script>
{% endblock %}
